{% extends 'layout/base.html' %}

{% block title %}Quản lý lịch hẹn{% endblock %}

{% block content %}
<div class="container my-4 col-lg-10">
    <div class="card shadow rounded-4 border-0">
        <div class="card-body p-4">
            <h2 class="h4 text-center mb-4 text-primary fw-bold">
                <i class="fa fa-calendar-check me-2"></i>Quản Lý Lịch Hẹn
            </h2>

            {% if appointments %}
            <div class="table-responsive">
                <table class="table table-hover table-striped align-middle">
                    <thead class="bg-primary text-white text-center">
                    <tr>
                        <th class="small text-uppercase">Bệnh nhân</th>
                        <th class="small text-uppercase">Ngày bắt đầu</th>
                        <th class="small text-uppercase">Ngày kết thúc</th>
                        <th class="small text-uppercase">Lý do</th>
                        <th class="small text-uppercase">Trạng thái</th>
                        <th class="small text-uppercase">Thao tác</th>
                    </tr>
                    </thead>
                    <tbody class="text-center">
                    {% for a in appointments %}
                    <tr class="bg-light">
                        <td class="fw-semibold">{{ a.patient.full_name }}</td>
                        <td>{{ a.start_at }}</td>
                        <td>{{ a.end_at }}</td>
                        <td>{{ a.reason }}</td>
                        <td>
                            {% if a.status.name == 'PENDING' %}
                            <span class="badge rounded-pill bg-warning text-dark px-3 py-2">Chờ xác nhận</span>
                            {% elif a.status.name == 'CONFIRMED' %}
                            <span class="badge rounded-pill bg-success px-3 py-2">Đã xác nhận</span>
                            {% elif a.status.name == 'COMPLETED' %}
                            <span class="badge rounded-pill bg-info text-dark px-3 py-2">Đã hoàn tất</span>
                            {% elif a.status.name == 'CANCELED' %}
                            <span class="badge rounded-pill bg-danger px-3 py-2">Đã hủy</span>
                            {% else %}
                            <span class="badge rounded-pill bg-secondary px-3 py-2">{{ a.status }}</span>
                            {% endif %}
                        </td>

                        <td>
                            <!-- các nút nhỏ gọn -->
                            <div class="d-flex justify-content-center gap-1">
                                {% if a.status.name == 'PENDING' %}
                                <!-- Xác nhận -->
                                <form action="{{ url_for('confirm_appointment', id=a.id) }}" method="post"
                                      class="d-inline">
                                    <button type="submit" class="btn btn-success btn-sm py-0 px-1" title="Xác nhận">
                                        <i class="fa fa-check fa-xs"></i>
                                    </button>
                                </form>

                                <!-- Hủy -->
                                <button type="button" class="btn btn-danger btn-sm py-0 px-1" title="Hủy"
                                        onclick="showCancelReason({{a.id}})">
                                    <i class="fa fa-times fa-xs"></i>
                                </button>

                                <!-- Đổi lịch -->
                                <a href="{{ url_for('reschedule_appointment', appointment_id=a.id) }}"
                                   class="btn btn-warning btn-sm py-0 px-1" title="Đổi lịch">
                                    <i class="fa fa-calendar fa-xs"></i>
                                </a>

                                {% elif a.status.name == 'CONFIRMED' %}
                                <!-- Hoàn tất -->
                                <form action="{{ url_for('complete_appointment', id=a.id) }}" method="post"
                                      class="d-inline">
                                    <button type="submit" class="btn btn-info btn-sm py-0 px-1" title="Hoàn tất">
                                        <i class="fa fa-check-double fa-xs"></i>
                                    </button>
                                </form>

                                <!-- Hủy -->
                                <button type="button" class="btn btn-danger btn-sm py-0 px-1" title="Hủy"
                                        onclick="showCancelReason({{a.id}})">
                                    <i class="fa fa-times fa-xs"></i>
                                </button>

                                <!-- Đổi lịch -->
                                <a href="{{ url_for('reschedule_appointment', appointment_id=a.id) }}"
                                   class="btn btn-warning btn-sm py-0 px-1" title="Đổi lịch">
                                    <i class="fa fa-calendar fa-xs"></i>
                                </a>

                                {% elif a.status.name == 'COMPLETED' %}
                                <!-- Xem hồ sơ -->
                                <a href="{{ url_for('view_patient_profile', patient_id=a.patient.id) }}"
                                   class="btn btn-primary btn-sm py-0 px-1" title="Xem hồ sơ">
                                    <i class="fa fa-user"></i>
                                </a>

                                <!-- Cập nhật bệnh án -->
                                <a href="{{ url_for('doctor_update_record', appointment_id=a.id) }}"
                                   class="btn btn-primary btn-sm py-0 px-1" title="Cập nhật bệnh án">
                                    <i class="fa fa-notes-medical"></i>
                                </a>

                                {% else %}
                                <span class="text-muted">Không có hành động</span>
                                {% endif %}
                            </div>

                            <!-- Form lý do hủy ẩn -->
                            <div id="cancelReason{{a.id}}" class="d-none mt-2">
                                <form action="{{ url_for('cancel_appointment', appointment_id=a.id) }}" method="post"
                                      class="d-flex justify-content-center gap-2">
                                    <input type="text" name="cancel_reason" placeholder="Lý do hủy"
                                           class="form-control form-control-sm w-auto">
                                    <button type="submit" class="btn btn-danger btn-sm py-0 px-1" title="Xác nhận hủy">
                                        <i class="fa fa-check fa-xs"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-center text-muted my-3">
                Hiện chưa có cuộc hẹn nào.
            </p>
            {% endif %}
        </div>
    </div>
</div>

<script>
    function showCancelReason(id) {
      const el = document.getElementById('cancelReason' + id);
      el.classList.toggle('d-none');
    }
</script>
{% endblock %}